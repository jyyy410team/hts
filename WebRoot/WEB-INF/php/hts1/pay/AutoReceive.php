<?
//加载配置
require_once("../pay/payconfig.php");
//****************************************	//MD5密钥要跟订单提交页相同，如Send.asp里的 key = "test" ,修改""号内 test 为您的密钥
											//如果您还没有设置MD5密钥请登陆我们为您提供商户后台，地址：https://merchant3.chinabank.com.cn/
	$key=$bkey;							//登陆后在上面的导航栏里可能找到“B2C”，在二级导航栏里有“MD5密钥设置”
											//建议您设置一个16位以上的密钥或更高，密钥最多64位，但设置16位已经足够了
//****************************************

$v_oid     =trim($_POST['v_oid']);      
$v_pmode   =trim($_POST['v_pmode']);      
$v_pstatus =trim($_POST['v_pstatus']);      
$v_pstring =trim($_POST['v_pstring']);      
$v_amount  =trim($_POST['v_amount']);     
$v_moneytype  =trim($_POST['v_moneytype']);     
$remark1   =trim($_POST['remark1' ]);     
$remark2   =trim($_POST['remark2' ]);     
$v_md5str  =trim($_POST['v_md5str' ]);     
/**
 * 重新计算md5的值
 */
                           
$md5string=strtoupper(md5($v_oid.$v_pstatus.$v_amount.$v_moneytype.$key)); //拼凑加密串
if ($v_md5str==$md5string)
{
	
   if($v_pstatus=="20")
	{
	   //支付成功
	   //商户系统的逻辑处理（例如判断金额，判断支付状态(20成功,30失败),更新订单状态等等）......
	   //加载数据库配置
		include ("../include/config.php");
		include ("../include/function.php");
		$VipUser=$_COOKIE["VipUser"];
		$flag=1;
		$data=date("Y-m-d h:i:s");
	    $sqlc="select * from caiwu where order_id='".$v_oid."'";
	    $resultc=mysql_db_query($dbname,$sqlc);
	    $rsc=mysql_fetch_array($resultc);
		if($rsc==NULL)
		{
			$sqls="select * from user where VipUser='".$VipUser."'";
			$results=mysql_db_query($dbname,$sqls);
			$rss=mysql_fetch_array($results);
			if($rss!=NULL)
			{
				$sql="insert into caiwu (order_id,VipUser,operator,leixing,jine,flag,data) values ('".$v_oid."','".$VipUser."','".$VipUser."','".$remark1."',".$v_amount.",".$flag.",'".$data."')";
				mysql_db_query($dbname,$sql);

				$yue=$rss["yue"]+$v_amount;
				$sqlu="update user set yue=".$yue." where VipUser='".$VipUser."'";
				mysql_db_query($dbname,$sqlu);
				echo "<script>alert('充值成功！');location.href='../user/right.php';</script>";
			}
			else{
				echo "<script>alert('充值异常，请与站长联系！');location.href='../user/right.php';</script>";
			}
		}
		
	}
  echo "ok";
	
}else{
	echo "error";
}
?>